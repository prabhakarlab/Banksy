<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spatial data integration with Harmony (10x Visium Human DLPFC) • Banksy</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Spatial data integration with Harmony (10x Visium Human DLPFC)">
<meta property="og:description" content="Banksy">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Banksy</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Functions and data</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/parameter-selection.html">BANKSY parameter selection (VeraFISH Mouse Hippocampus)</a>
    </li>
    <li>
      <a href="../articles/domain-segment.html">Domain segmentation (STARmap PLUS Mouse brain)</a>
    </li>
    <li>
      <a href="../articles/batch-correction.html">Spatial data integration with Harmony (10x Visium Human DLPFC)</a>
    </li>
    <li>
      <a href="../articles/multi-sample.html">Analysing multiple datasets (10x Visium Human DLPFC)</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/prabhakarlab/Banksy/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Spatial data integration with Harmony (10x
Visium Human DLPFC)</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/prabhakarlab/Banksy/blob/HEAD/vignettes/batch-correction.Rmd" class="external-link"><code>vignettes/batch-correction.Rmd</code></a></small>
      <div class="hidden name"><code>batch-correction.Rmd</code></div>

    </div>

    
    
<p>Here, we demonstrate how BANKSY can be used with Harmony for
integrating multiple spatial omics datasets. We use 10x Visium data of
the human dorsolateral prefrontal cortex from Maynard et al (2018). The
data comprise 12 samples obtained from 3 subjects, with manual
annotation of the layers in each sample.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/prabhakarlab/Banksy" class="external-link">Banksy</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bioconductor.org/packages/SummarizedExperiment" class="external-link">SummarizedExperiment</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/drighelli/SpatialExperiment" class="external-link">SpatialExperiment</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">singleCellTK</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">scran</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">harmony</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://bioconductor.org/packages/scater/" class="external-link">scater</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lmweber/ggspavis" class="external-link">ggspavis</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">SEED</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span></code></pre></div>
<div class="section level2">
<h2 id="loading-the-data">Loading the data<a class="anchor" aria-label="anchor" href="#loading-the-data"></a>
</h2>
<p>We fetch the data for all 12 DLPFC samples with the <a href="https://bioconductor.org/packages/release/data/experiment/html/spatialLIBD.html" class="external-link"><em>spatialLIBD</em></a>
package. This might take awhile.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">spatialLIBD</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ExperimentHub</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ehub</span> <span class="op">&lt;-</span> <span class="fu">ExperimentHub</span><span class="fu">::</span><span class="fu">ExperimentHub</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu">spatialLIBD</span><span class="fu">::</span><span class="fu">fetch_data</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"spe"</span>, eh <span class="op">=</span> <span class="va">ehub</span><span class="op">)</span></span>
<span><span class="va">sample_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">spe</span><span class="op">$</span><span class="va">sample_id</span><span class="op">)</span></span></code></pre></div>
<p>After the download is completed, we trim the
<em>SpatialExperiment</em> object, retaining only the counts and some
metadata such as the sample identifier and pathology annotations. This
saves some memory.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Remove NA spots</span></span>
<span><span class="va">na_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">spe</span><span class="op">$</span><span class="va">layer_guess_reordered_short</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">spe</span> <span class="op">&lt;-</span> <span class="va">spe</span><span class="op">[</span>, <span class="op">-</span><span class="va">na_id</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#' Trim</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-methods.html" class="external-link">imgData</a></span><span class="op">(</span><span class="va">spe</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">spe</span>, <span class="st">"logcounts"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDims</a></span><span class="op">(</span><span class="va">spe</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">rowData</a></span><span class="op">(</span><span class="va">spe</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">spe</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">DataFrame</span><span class="op">(</span></span>
<span>    sample_id <span class="op">=</span> <span class="va">spe</span><span class="op">$</span><span class="va">sample_id</span>,</span>
<span>    subject_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">spe</span><span class="op">$</span><span class="va">sample_id</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Subject"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    clust_annotation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">spe</span><span class="op">$</span><span class="va">layer_guess_reordered_short</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    in_tissue <span class="op">=</span> <span class="va">spe</span><span class="op">$</span><span class="va">in_tissue</span>,</span>
<span>    row.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spe</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spe</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spe</span><span class="op">)</span>, <span class="st">"_"</span>, <span class="va">spe</span><span class="op">$</span><span class="va">sample_id</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Next, stagger the spatial coordinates across the samples so that
spots from different samples do not overlap.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Stagger spatial coordinates</span></span>
<span><span class="va">locs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-methods.html" class="external-link">spatialCoords</a></span><span class="op">(</span><span class="va">spe</span><span class="op">)</span></span>
<span><span class="va">locs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">locs</span>, sample_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">spe</span><span class="op">$</span><span class="va">sample_id</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">locs_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span><span class="va">locs</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">locs_dt</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sdimx"</span>, <span class="st">"sdimy"</span>, <span class="st">"group"</span><span class="op">)</span></span>
<span><span class="va">locs_dt</span><span class="op">[</span>, <span class="va">sdimx</span> <span class="op">:=</span> <span class="va">sdimx</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">sdimx</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">group</span><span class="op">]</span></span>
<span><span class="va">global_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">locs_dt</span><span class="op">$</span><span class="va">sdimx</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1.5</span></span>
<span><span class="va">locs_dt</span><span class="op">[</span>, <span class="va">sdimx</span> <span class="op">:=</span> <span class="va">sdimx</span> <span class="op">+</span> <span class="va">group</span> <span class="op">*</span> <span class="va">global_max</span><span class="op">]</span></span>
<span><span class="va">locs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">locs_dt</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">locs</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">spe</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-methods.html" class="external-link">spatialCoords</a></span><span class="op">(</span><span class="va">spe</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">locs</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-preprocessing">Data preprocessing<a class="anchor" aria-label="anchor" href="#data-preprocessing"></a>
</h2>
<p>Find highly variable features:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Get HVGs</span></span>
<span><span class="va">hvgs</span> <span class="op">&lt;-</span> <span class="fu">singleCellTK</span><span class="fu">::</span><span class="fu">getTopHVG</span><span class="op">(</span></span>
<span>    <span class="fu">singleCellTK</span><span class="fu">::</span><span class="fu">runSeuratFindHVG</span><span class="op">(</span></span>
<span>        <span class="va">spe</span>,</span>
<span>        hvgNumber <span class="op">=</span> <span class="fl">2000</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span>,</span>
<span>    hvgNumber <span class="op">=</span> <span class="fl">2000</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Normalize counts:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Normalize the data.</span></span>
<span><span class="va">scale_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/MatrixGenerics/man/rowSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">spe</span>, <span class="st">"counts"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">aname</span> <span class="op">&lt;-</span> <span class="st">"normcounts"</span></span>
<span><span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu">singleCellTK</span><span class="fu">::</span><span class="fu">runSeuratNormalizeData</span><span class="op">(</span></span>
<span>    <span class="va">spe</span>,</span>
<span>    useAssay <span class="op">=</span> <span class="st">"counts"</span>,</span>
<span>    normAssayName <span class="op">=</span> <span class="va">aname</span>,</span>
<span>    normalizationMethod <span class="op">=</span> <span class="st">"RC"</span>,</span>
<span>    scaleFactor <span class="op">=</span> <span class="va">scale_factor</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">spe</span> <span class="op">&lt;-</span> <span class="va">spe</span><span class="op">[</span><span class="va">hvgs</span>, <span class="op">]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="running-banksy">Running BANKSY<a class="anchor" aria-label="anchor" href="#running-banksy"></a>
</h2>
<p>Compute BANKSY neighborhood matrices. We use <code>k_geom=18</code>
corresponding to first and second-order neighbors in 10x Visium.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">compute_agf</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="va">k_geom</span> <span class="op">&lt;-</span> <span class="fl">18</span></span>
<span><span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/computeBanksy.html">computeBanksy</a></span><span class="op">(</span><span class="va">spe</span>, assay_name <span class="op">=</span> <span class="va">aname</span>, compute_agf <span class="op">=</span> <span class="va">compute_agf</span>, k_geom <span class="op">=</span> <span class="va">k_geom</span><span class="op">)</span></span></code></pre></div>
<p>Run PCA on the BANKSY matrix:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">npcs</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">use_agf</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runBanksyPCA.html">runBanksyPCA</a></span><span class="op">(</span><span class="va">spe</span>, use_agf <span class="op">=</span> <span class="va">use_agf</span>, lambda <span class="op">=</span> <span class="va">lambda</span>, npcs <span class="op">=</span> <span class="va">npcs</span>, seed <span class="op">=</span> <span class="va">SEED</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="run-harmony-on-banksys-embedding">Run Harmony on BANKSY’s embedding<a class="anchor" aria-label="anchor" href="#run-harmony-on-banksys-embedding"></a>
</h2>
<p>We run Harmony on the PCs of the BANKSY matrix:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">SEED</span><span class="op">)</span></span>
<span><span class="va">harmony_embedding</span> <span class="op">&lt;-</span> <span class="fu">HarmonyMatrix</span><span class="op">(</span></span>
<span>    data_mat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">spe</span>, <span class="st">"PCA_M1_lam0.2"</span><span class="op">)</span>,</span>
<span>    meta_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">spe</span><span class="op">)</span>,</span>
<span>    vars_use <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sample_id"</span>, <span class="st">"subject_id"</span><span class="op">)</span>,</span>
<span>    do_pca <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    max.iter.harmony <span class="op">=</span> <span class="fl">20</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">spe</span>, <span class="st">"Harmony_BANKSY"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">harmony_embedding</span></span></code></pre></div>
<p>Next, run UMAP on the ‘raw’ and Harmony corrected PCA embeddings:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">k_exp</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runBanksyUMAP.html">runBanksyUMAP</a></span><span class="op">(</span><span class="va">spe</span>, use_agf <span class="op">=</span> <span class="cn">TRUE</span>, lambda <span class="op">=</span> <span class="va">lambda</span>, npcs <span class="op">=</span> <span class="va">npcs</span>, n_neighbors <span class="op">=</span> <span class="va">k_exp</span><span class="op">)</span></span>
<span><span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runBanksyUMAP.html">runBanksyUMAP</a></span><span class="op">(</span><span class="va">spe</span>, dimred <span class="op">=</span> <span class="st">"Harmony_BANKSY"</span>, n_neighbors <span class="op">=</span> <span class="va">k_exp</span><span class="op">)</span></span></code></pre></div>
<p>Visualize the UMAPs annotated by subject ID:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">um_point_size</span> <span class="op">&lt;-</span> <span class="fl">0.05</span></span>
<span><span class="va">um_point_alpha</span> <span class="op">&lt;-</span> <span class="fl">0.05</span></span>
<span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html" class="external-link">plotReducedDim</a></span><span class="op">(</span><span class="va">spe</span>, <span class="st">"UMAP_M1_lam0.2"</span>,</span>
<span>        color_by <span class="op">=</span> <span class="st">"subject_id"</span>,</span>
<span>        point_size <span class="op">=</span> <span class="va">um_point_size</span>, point_alpha <span class="op">=</span> <span class="va">um_point_alpha</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotReducedDim.html" class="external-link">plotReducedDim</a></span><span class="op">(</span><span class="va">spe</span>, <span class="st">"UMAP_Harmony_BANKSY"</span>,</span>
<span>        color_by <span class="op">=</span> <span class="st">"subject_id"</span>,</span>
<span>        point_size <span class="op">=</span> <span class="va">um_point_size</span>, point_alpha <span class="op">=</span> <span class="va">um_point_alpha</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    nrow <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    rel_widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1.2</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="batch-correction_files/figure-html/unnamed-chunk-14-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Cluster the Harmony corrected PCA embedding:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clusterBanksy.html">clusterBanksy</a></span><span class="op">(</span><span class="va">spe</span>, dimred <span class="op">=</span> <span class="st">"Harmony_BANKSY"</span>, k_neighbors <span class="op">=</span> <span class="va">k_exp</span>, resolution <span class="op">=</span> <span class="fl">0.55</span>, seed <span class="op">=</span> <span class="va">SEED</span><span class="op">)</span></span>
<span><span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/connectClusters.html">connectClusters</a></span><span class="op">(</span><span class="va">spe</span>, map_to <span class="op">=</span> <span class="st">"clust_annotation"</span><span class="op">)</span></span></code></pre></div>
<p>Generate spatial plots:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sp_point_size</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="va">cnm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clusterNames.html">clusterNames</a></span><span class="op">(</span><span class="va">spe</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">spatial_plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">sample_names</span>, <span class="kw">function</span><span class="op">(</span><span class="va">snm</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">spe</span><span class="op">[</span>, <span class="va">spe</span><span class="op">$</span><span class="va">sample_id</span> <span class="op">==</span> <span class="va">snm</span><span class="op">]</span></span>
<span>    <span class="va">ari</span> <span class="op">&lt;-</span> <span class="fu">aricode</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/aricode/man/ARI.html" class="external-link">ARI</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">clust_annotation</span>, <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span>, <span class="va">cnm</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ggspavis/man/plotSpots.html" class="external-link">plotSpots</a></span><span class="op">(</span><span class="va">x</span>, annotate <span class="op">=</span> <span class="va">cnm</span>, palette <span class="op">=</span> <span class="fu">pals</span><span class="fu">::</span><span class="fu"><a href="https://kwstat.github.io/pals/reference/discrete.html" class="external-link">kelly</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, size <span class="op">=</span> <span class="va">sp_point_size</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span>, plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Sample %s - ARI: %s"</span>, <span class="va">snm</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">ari</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">spatial_plots</span>, nrow <span class="op">=</span> <span class="fl">4</span>, byrow <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="batch-correction_files/figure-html/unnamed-chunk-16-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<details><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.3.1 (2023-06-16)</span></span>
<span><span class="co">#&gt; Platform: aarch64-apple-darwin20 (64-bit)</span></span>
<span><span class="co">#&gt; Running under: macOS Ventura 13.3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib </span></span>
<span><span class="co">#&gt; LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt; [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: Europe/London</span></span>
<span><span class="co">#&gt; tzcode source: internal</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">#&gt; [8] base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt;  [1] ggspavis_1.6.0              cowplot_1.1.1              </span></span>
<span><span class="co">#&gt;  [3] scater_1.28.0               ggplot2_3.4.3              </span></span>
<span><span class="co">#&gt;  [5] scuttle_1.9.4               SpatialExperiment_1.10.0   </span></span>
<span><span class="co">#&gt;  [7] SingleCellExperiment_1.22.0 SummarizedExperiment_1.30.2</span></span>
<span><span class="co">#&gt;  [9] Biobase_2.60.0              GenomicRanges_1.52.0       </span></span>
<span><span class="co">#&gt; [11] GenomeInfoDb_1.36.3         IRanges_2.34.1             </span></span>
<span><span class="co">#&gt; [13] S4Vectors_0.38.2            BiocGenerics_0.46.0        </span></span>
<span><span class="co">#&gt; [15] MatrixGenerics_1.12.3       matrixStats_1.0.0          </span></span>
<span><span class="co">#&gt; [17] Banksy_0.2.5               </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;   [1] bitops_1.0-7              gridExtra_2.3            </span></span>
<span><span class="co">#&gt;   [3] rlang_1.1.1               magrittr_2.0.3           </span></span>
<span><span class="co">#&gt;   [5] compiler_4.3.1            sccore_1.0.4             </span></span>
<span><span class="co">#&gt;   [7] DelayedMatrixStats_1.22.6 maps_3.4.1               </span></span>
<span><span class="co">#&gt;   [9] systemfonts_1.0.4         vctrs_0.6.3              </span></span>
<span><span class="co">#&gt;  [11] stringr_1.5.0             pkgconfig_2.0.3          </span></span>
<span><span class="co">#&gt;  [13] crayon_1.5.2              fastmap_1.1.1            </span></span>
<span><span class="co">#&gt;  [15] magick_2.8.0              XVector_0.40.0           </span></span>
<span><span class="co">#&gt;  [17] labeling_0.4.3            utf8_1.2.3               </span></span>
<span><span class="co">#&gt;  [19] rmarkdown_2.25            ggbeeswarm_0.7.2         </span></span>
<span><span class="co">#&gt;  [21] ragg_1.2.5                purrr_1.0.2              </span></span>
<span><span class="co">#&gt;  [23] xfun_0.40                 pals_1.8                 </span></span>
<span><span class="co">#&gt;  [25] zlibbioc_1.46.0           cachem_1.0.8             </span></span>
<span><span class="co">#&gt;  [27] beachmat_2.16.0           jsonlite_1.8.7           </span></span>
<span><span class="co">#&gt;  [29] rhdf5filters_1.12.1       DelayedArray_0.26.7      </span></span>
<span><span class="co">#&gt;  [31] Rhdf5lib_1.22.1           BiocParallel_1.34.2      </span></span>
<span><span class="co">#&gt;  [33] irlba_2.3.5.1             parallel_4.3.1           </span></span>
<span><span class="co">#&gt;  [35] aricode_1.0.2             R6_2.5.1                 </span></span>
<span><span class="co">#&gt;  [37] bslib_0.5.1               stringi_1.7.12           </span></span>
<span><span class="co">#&gt;  [39] limma_3.56.2              leidenAlg_1.1.2          </span></span>
<span><span class="co">#&gt;  [41] jquerylib_0.1.4           Rcpp_1.0.11              </span></span>
<span><span class="co">#&gt;  [43] knitr_1.44                R.utils_2.12.2           </span></span>
<span><span class="co">#&gt;  [45] Matrix_1.6-1.1            igraph_1.5.1             </span></span>
<span><span class="co">#&gt;  [47] tidyselect_1.2.0          dichromat_2.0-0.1        </span></span>
<span><span class="co">#&gt;  [49] viridis_0.6.4             rstudioapi_0.15.0        </span></span>
<span><span class="co">#&gt;  [51] abind_1.4-5               yaml_2.3.7               </span></span>
<span><span class="co">#&gt;  [53] codetools_0.2-19          lattice_0.21-9           </span></span>
<span><span class="co">#&gt;  [55] tibble_3.2.1              withr_2.5.1              </span></span>
<span><span class="co">#&gt;  [57] evaluate_0.22             desc_1.4.2               </span></span>
<span><span class="co">#&gt;  [59] pillar_1.9.0              generics_0.1.3           </span></span>
<span><span class="co">#&gt;  [61] dbscan_1.1-11             rprojroot_2.0.3          </span></span>
<span><span class="co">#&gt;  [63] RCurl_1.98-1.12           sparseMatrixStats_1.12.2 </span></span>
<span><span class="co">#&gt;  [65] munsell_0.5.0             scales_1.2.1             </span></span>
<span><span class="co">#&gt;  [67] glue_1.6.2                mapproj_1.2.11           </span></span>
<span><span class="co">#&gt;  [69] tools_4.3.1               BiocNeighbors_1.18.0     </span></span>
<span><span class="co">#&gt;  [71] data.table_1.14.8         ScaledMatrix_1.8.1       </span></span>
<span><span class="co">#&gt;  [73] locfit_1.5-9.8            ggside_0.2.2             </span></span>
<span><span class="co">#&gt;  [75] fs_1.6.3                  rhdf5_2.44.0             </span></span>
<span><span class="co">#&gt;  [77] grid_4.3.1                DropletUtils_1.20.0      </span></span>
<span><span class="co">#&gt;  [79] edgeR_3.42.4              colorspace_2.1-0         </span></span>
<span><span class="co">#&gt;  [81] GenomeInfoDbData_1.2.10   RcppHungarian_0.3        </span></span>
<span><span class="co">#&gt;  [83] beeswarm_0.4.0            BiocSingular_1.16.0      </span></span>
<span><span class="co">#&gt;  [85] HDF5Array_1.28.1          vipor_0.4.5              </span></span>
<span><span class="co">#&gt;  [87] cli_3.6.1                 rsvd_1.0.5               </span></span>
<span><span class="co">#&gt;  [89] textshaping_0.3.6         fansi_1.0.4              </span></span>
<span><span class="co">#&gt;  [91] viridisLite_0.4.2         S4Arrays_1.0.6           </span></span>
<span><span class="co">#&gt;  [93] dplyr_1.1.3               uwot_0.1.16              </span></span>
<span><span class="co">#&gt;  [95] gtable_0.3.4              R.methodsS3_1.8.2        </span></span>
<span><span class="co">#&gt;  [97] sass_0.4.7                digest_0.6.33            </span></span>
<span><span class="co">#&gt;  [99] ggrepel_0.9.3             dqrng_0.3.1              </span></span>
<span><span class="co">#&gt; [101] farver_2.1.1              rjson_0.2.21             </span></span>
<span><span class="co">#&gt; [103] memoise_2.0.1             htmltools_0.5.6          </span></span>
<span><span class="co">#&gt; [105] pkgdown_2.0.7             R.oo_1.25.0              </span></span>
<span><span class="co">#&gt; [107] lifecycle_1.0.3</span></span></code></pre></div>
</details>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Vipul Singhal, Joseph Lee.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
